<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Google Code Jam Tracker</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap4.min.js"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.3/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap4.min.css"
    />

    <script>
      $(async function () {
        const GITHUB_API_BASE_URL =
          "https://api.github.com/repos/charles-wangkai/codejam";
        const GITHUB_USERNAME = "charles-wangkai";
        const GITHUB_TOKEN = "c34bea9de0b57e79b3667ebeb7ea4e51a9f6ac7b";

        function getGithubApi(url, options = {}) {
          return $.get({
            url: url,
            beforeSend: function (xhr) {
              xhr.setRequestHeader(
                "Authorization",
                "Basic " + btoa(`${GITHUB_USERNAME}:${GITHUB_TOKEN}`)
              );
            },
            ...options,
          });
        }

        let dataset = await $.get({
          url: "codejam_dataset.json",
          dataType: "json",
        });

        let problems = [];
        for (let year of dataset.years) {
          for (
            let roundIndex = 0;
            roundIndex < year.rounds.length;
            ++roundIndex
          ) {
            let round = year.rounds[roundIndex];
            for (
              let problemIndex = 0;
              problemIndex < round.problems.length;
              ++problemIndex
            ) {
              let problem = round.problems[problemIndex];

              problems.push({
                year: year,
                round: round,
                problem: problem,
                index: `${year.name}-${String.fromCharCode(
                  "A".charCodeAt(0) + year.rounds.length - 1 - roundIndex
                )}-${String.fromCharCode("A".charCodeAt(0) + problemIndex)}`,
              });
            }
          }
        }

        data = await getGithubApi(
          `${GITHUB_API_BASE_URL}/git/ref/heads/master`,
          {
            cache: false,
          }
        );
        data = await getGithubApi(data.object.url);
        data = await getGithubApi(`${data.tree.url}?recursive=1`);

        const githubPaths = new Set(data.tree.map((object) => object.path));

        problems.forEach((problem) => {
          const path = `${problem.yearName}/${problem.roundName}/${problem.problemName}/Solution.java`;

          if (githubPaths.has(path)) {
            problem.submissionUrl = `https://github.com/charles-wangkai/codejam/blob/master/${path}`;
          }
        });

        problems.forEach((problem) => {
          const submission = problem.submissionUrl
            ? `<a href="${problem.submissionUrl}">Solution</a>`
            : "";

          $("#problems tbody").append(`
              <tr>
                <th scope="row"><a href="${problem.problem.url}">${problem.problem.name}</a></th>
                <td><a href="${problem.year.url}">${problem.year.name}</a></td>
                <td><a href="${problem.round.url}">${problem.round.name}</a></td>
                <td><a href="${problem.problem.url}">${problem.index}</a></td>
                <td>${submission}</td>
              </tr>
          `);
        });

        $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
          const filterType = $(
            "input[type=radio][name=filterType]:checked"
          ).val();

          return (
            filterType === "all" || (filterType === "todo") === (data[4] === "")
          );
        });

        const table = $("#problems").DataTable({
          paging: false,
          order: [[3, "asc"]],
        });

        $("input[type=radio][name=filterType]").change(function () {
          table.draw();
        });
      });
    </script>
  </head>

  <body>
    <div class="row m-1">
      <div class="col-sm">
        <div class="card">
          <div class="card-header">Problem List</div>
          <div class="card-body">
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                name="filterType"
                id="filterAll"
                value="all"
                checked
              />
              <label class="form-check-label" for="filterAll">All</label>
            </div>
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                name="filterType"
                id="filterTodo"
                value="todo"
              />
              <label class="form-check-label" for="filterTodo">Todo</label>
            </div>
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                name="filterType"
                id="filterSolved"
                value="solved"
              />
              <label class="form-check-label" for="filterSolved">Solved</label>
            </div>

            <table id="problems" class="table table-striped">
              <thead>
                <tr>
                  <th scope="col">Problem Title</th>
                  <th scope="col">Year</th>
                  <th scope="col">Round</th>
                  <th scope="col">Index</th>
                  <th scope="col">Submission</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
